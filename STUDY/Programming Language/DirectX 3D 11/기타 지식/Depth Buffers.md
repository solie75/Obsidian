z-Buffer 또는 w-Buffer 로도 불리는 depth buffer(깊이 버퍼)는 Direct3d 에서 사용되는 깊이 정보를 저장하는 장치의 속성이다. Direct3D 가 하나의 장면을 target surface 에 render 할 때, 레스터화된 폴리곤의 픽셀이 또다른 것과 서로 어떻게 가리는지를 결정하는데 연결된 depth-buffer surface 의 메모리를 작업 영역으로 사용할 수 있다. Direct3D 는 최종 색이 기록되는 대상으로서 off-buffer Direct3D surface 를 사용한다. render-target surface와 관련된 depth-buffer surface 는 Direct3D 가 어떻게 각각의 픽셀의 깊이 값을 설명하는 지에 대한 깊이 정보를 저장하는데 사용된다.

scene(장면)이 깊이 버퍼가 활성화가 된 상태로 레스터화 될 때, rendering surface 의 각 point(지점)이 테스트 된다. (<span style="color:green"> 여기에서 말하는 테스트란..? </span>)  depth buffer의 값은 Projection space(사영 공간)에 위치한 point 의 (x, y, x, w) 위치에서  z 좌표나, 균일한 w 좌표가 될 수 있다. z 좌표를 사용하면  z-buffer, w 좌표 를 사용하면 w-buffer 라고 한다. 각 유형의 깊이 버퍼에는 장단점이 존재한다.

테스트의 시작에서는 깊이 버퍼의 깊이 값은 scene(장면)에 대해서 가능한 가장 큰 값이 설정된다. rendering surface의 색 값은 배경의 색 값 혹은 해당 point 의 배경 텍스쳐의 색 값으로 설정된다. scene 내의 각 polygon은 rendering surface 위의 현재 (x, y)좌표 와 교차하는지 보기(확인 하기)위해 테스트 된다. 만약 교체하였다면 현재 poinrt의 깊이 값은 depth buffer 에 저장되어 있는 깊이 값과 비교하여 작은지 테스트 된다. 만약 그 Polygon 의 깊이 값이 작다면, 그것은 depth buffer 에 저장되고 polygon의 색 값은 rendering surface의 현재 point 에 저장된다. 반대로 polygon 의 해당 point의 깊이 값이 더 크다면, 리스트의 다음 polygon이 테스트 된다. 이 과정은 아래의 그림과 같다.

![[Pasted image 20221217162630.png]]

## Z-buffer 와 w-buffer의 각 장단점

Nearly all accelerators on the market support z-buffering, making z-buffers the most common type of depth buffer today. However ubiquitous, z-buffers have their drawbacks. Due to the mathematics involved, the generated z values in a z-buffer tend not to be distributed evenly across the z-buffer range (typically 0.0 to 1.0, inclusive). Specifically, the ratio between the far and near clipping planes strongly affects how unevenly z values are distributed. Using a far-plane distance to near-plane distance ratio of 100, 90 percent of the depth buffer range is spent on the first 10 percent of the scene depth range. Typical applications for entertainment or visual simulations with exterior scenes often require far-plane/near-plane ratios of anywhere between 1,000 to 10,000. At a ratio of 1,000, 98 percent of the range is spent on the first 2 percent of the depth range, and the distribution becomes worse with higher ratios. This can cause hidden surface artifacts in distant objects, especially when using 16-bit depth buffers, the most commonly supported bit-depth.

A w-based depth buffer, on the other hand, is often more evenly distributed between the near and far clip planes than a z-buffer. The key benefit is that the ratio of distances for the far and near clipping planes is no longer an issue. This allows applications to support large maximum ranges, while still getting relatively accurate depth buffering close to the eye point. A w-based depth buffer isn't perfect, and can sometimes exhibit hidden surface artifacts for near objects. Another drawback to the w-buffered approach is related to hardware support: w-buffering isn't supported as widely in hardware as z-buffering.

Using a z-buffer requires overhead during rendering. Various techniques can be used to optimize rendering when using z-buffers. For details, see [Z-Buffer Performance](https://learn.microsoft.com/en-us/windows/win32/direct3d9/performance-optimizations).