- new
new 를 사용하여 메모리 할당을 하면 내부적으로는 malloc 을 delete를 사용하여 메모리를 해제하게 되면 내부적으로는 free 를 호출한다.
malloc은 Heap Menager 에게 메모리 할당을 요청하고, Heap Manager는 관리하고 있는 힙에서 4바이트 만큼의 메모리 블럭을 찾은후 , 해당 메모리 주소를 반환한다. free 가 일어나면 할당 내역에서 해당 메모리 주소를 찾아 할당된 사이즈 만큼 해제한다.

- new[]
int 한 개를 맴버 변수를 가진  class 인 Test 가 있다고 가정할 때, Test* mTest = new Test[2];는 내부적으로 malloc(2* sizeof(Test)+ 4) 이 된다. Heap manager 는 요청받은 만큼 12바이트를 할당하고 해당 주소를 반환하는데 이때, new[] operator 는 받은 주소 +4의 주소를 반환하게 된다.


```c
void* malloc(size_t Size);
void free(void* Block);
```
malloc() 은 프로그래머가 입력한 size_t Size 인자를 통해, 필요한 메모리 크기를 OS 에 요청하고 OS 는 메모리를 할당한며 이때의 메모리 주소를 malloc 이 반환한다.
free(); 가 호출되면 free 는 해제하려는 대상의 포인터를 CRT(C Runtime Library)의 Heap Manager에게 넘겨준다. Heap Manager에는 malloc()으로 할당된 메모리 주소와 할당된 크기가 기록되어 있다. Heap Manager 는 free 로 부터 포인터를 받으면 그 포인터 값이 기록 중에 있는지 유효성 검사를 한 뒤, 있다는 것이 확인되면, 해당 주소와 크기에 해당하는 메모리를 해제시키고 해당 메모리의 기록을 지운다.

c++ 에서는 클래스 를 적용시켜야 하기 때문에 다음과 같다.
malloc() 호출 + 클래스 생성자 호출 -> new or new[],
free() 호출 + 클래스 소멸자 호출 -> delete or delete[]

new[5]; 와 같은 경우 new[] 는 OS 에 ' 프로그래머가 정한 크기 + 4 바이트 (추가 메모리) '를 OS에 요청한다. OS 가 주소를 할당해서 주면 new[]는 그 주소로 시작하는 맨 앞 4 바이트에 배열 크기 값을 넣어두고, 그 다음 주소 부터 생성자를 호출하며 프로그래머가 정한 크기의 데이터를 할당했다. 그리고 malloc() 이 반환할 주소 에 4를 더하여 돌려주었다.

따라서 delete[] 는 free() 에 'malloc() 이 반환할 주소 + 4' - 4를 넘겨준다. free()는 넘겨받은 주소를  Heap Manager 에게 전달하고  Heap Manager 은 유효성 검사를 한뒤 메모리의 해체 요청을 승인한다. 

new[]가 맨 앞 4바이트에 5를 기록하는 이유는 , 소멸자 호출 때문이다.
할당한 객체가 여러 개면, 나중에 delete[]가 배열 크기 만큼 여러번 소멸자를 호출해야 하는데. 이 delete[] 가 배열 크기를 알 만한 방도가 없다.

순서

```c++
class Test
{
    int a;
}
Test * t1 = new Test[5];
```
1. new[]가  'Test'의 크기를 추론해서 malloc() 에게 ' 객체 크기 * 객체 개수 + 4바이트 '를 넘긴다.
2. malloc() 은 OS에 해당 크기만큼의 메모리 할당 요청을 한다.
3. OS 가 유효한 주소를 넘겨주고, Heap Manager는 어느 주소에 얼마의 크기를 할당해 주었는지 기록한다.
4. malloc()이 OS로부터 넘겨받은 주소에 new[] 가 4바이트를 더한다.
5. 객체 포인터에게 4 바이트 더해진 주소값이 반환된다.
6. new[] 가 할당받은 곳 맨 앞 4 바이트에는 객체의 객수를 기록하고, 그 뒤(OS 로 부터 할당받은 주소)로부터는 객체의 메모리 기록
7. delete[]가 t1 - 4바이트 주소에 있는 크기 만큼 객체 소멸자를 호출하고, free 에게 t1-4의 주소를 넘겨준다. free 는 Heap Manager에게 넘겨받은 주소로 메모리 해제 요청을 한다.
8. Heap Manager가 기록 중에 t1-4의 조소가 있는지 유효성 검사를 하고 있으면 메모리를 해제한다.
